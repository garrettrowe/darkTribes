"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var INIT_TIMEOUT=3e4,CognosApi=function(){function e(t){if(_classCallCheck(this,e),!t||!t.node||!t.cognosRootURL)throw new Error("Invalid options parameter passed into the constructor. Must provide both options.node and options.cognosRootURL in the options parameter.");this._node=t.node,this._cognosURL=t.cognosRootURL,this._testURL=t.testURL,this._sessionCode=t.sessionCode,this._initTimeout=t.initTimeout||INIT_TIMEOUT,this._apiKey=e._createUID("capi"),this._pendingRequests={},this._eventCallbacks={},this._eventReverseLookup={},this._message_regex=new RegExp("#capi#(.+)#"+this._apiKey+"#(.*)$","g"),this.updateModuleDefinitions=e._updateModuleDefinitions.bind(this)}return _createClass(e,[{key:"initialize",value:function(){var t=this;return this._readyPromise||(this._readyPromise=new Promise(function(i,n){var s=setTimeout(t._onInitTimeout.bind(t,n),t._initTimeout);t._initializeContainer(),t._initializeService().then(function(){clearTimeout(s),t._sendMessage({apiId:t._apiKey,actionId:e._createUID(e.APISERVICE_INIT),name:e.APISERVICE_INIT},i,n)})})),this._readyPromise}},{key:"on",value:function(t,i){this._eventReverseLookup[i]||this._sendMessage({apiId:this._apiKey,actionId:e._createUID(e.APISERVICE_ON),name:e.APISERVICE_ON,parameters:Array.prototype.slice.call(arguments)},i)}},{key:"off",value:function(t,i){this._eventReverseLookup[i]&&this._sendMessage({apiId:this._apiKey,actionId:this._eventReverseLookup[i],name:e.APISERVICE_OFF,parameters:Array.prototype.slice.call(arguments)},i)}},{key:"_onInitTimeout",value:function(e){this._cleanupContainer(),e(new Error("Initialization timeout. "+this._initTimeout+"ms"))}},{key:"_initializeContainer",value:function(){var t=document.createElement("iframe");t.src=this._buildSourceUrl(),t.setAttribute("class",e.APISERVICE_CLASS),t.setAttribute("style","height:100%; width:100%;"),t.setAttribute("frameBorder","0"),this._node.innerHTML="",this._node.appendChild(t),this._target=t.contentWindow,this._targetOrigin=(/(https*:\/\/[^\/]+)/.exec(this._cognosURL)||[window.location.origin])[0]}},{key:"close",value:function(){var e=this;return new Promise(function(t,i){e._destroyService().then(function(i){e._cleanupApiService(),e._cleanupContainer(),t(i)},function(e){i(e)})})}},{key:"_buildSourceUrl",value:function(){if(this._testURL)return this._testURL;var e=this._cognosURL+(-1===this._cognosURL.indexOf("?")?"?":"&"),t={perspective:"postMessageApiLoader",apiKey:this._apiKey,parentOrigin:window.location.origin,sessionCode:this._sessionCode};return e+Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}},{key:"_cleanupApiService",value:function(){var e=this;this._messageHandler&&window.removeEventListener("message",this._messageHandler,!1),Object.keys(this).forEach(function(t){0!==t.indexOf("_")&&"object"===_typeof(e[t])&&e[t].apiId&&delete e[t]}),this._pendingRequests={},this._eventCallbacks={},this._eventReverseLookup={},this._messageHandler=null,this.apiId=null}},{key:"_cleanupContainer",value:function(){if(this._node){var t=this._node.getElementsByClassName(e.APISERVICE_CLASS)||[];1===t.length&&this._node.removeChild(t[0])}this._readyPromise=null,this._targetOrigin=null,this._target=null}},{key:"_initializeService",value:function(){var e=this;return this._messageHandler=this._receiveMessage.bind(this),window.addEventListener("message",this._messageHandler,!1),new Promise(function(t,i){e._registerResponseCallbacks(e._apiKey,t,i)})}},{key:"_destroyService",value:function(){var t=this;return new Promise(function(i,n){t._sendMessage({apiId:t._apiKey,actionId:e._createUID(e.APISERVICE_DESTROY),name:e.APISERVICE_DESTROY},i,n)})}},{key:"_registerResponseCallbacks",value:function(e,t,i){e&&t&&(this._pendingRequests[e]={success:t,fail:i})}},{key:"_resolveResponseCallbacks",value:function(e,t){e&&this._pendingRequests[e]&&(this._pendingRequests[e].success(t),delete this._pendingRequests[e])}},{key:"_rejectResponseCallbacks",value:function(e,t){e&&this._pendingRequests[e]&&(this._pendingRequests[e].fail(t),delete this._pendingRequests[e])}},{key:"_registerEventCallbacks",value:function(e,t){e&&t&&(this._eventCallbacks[e]=t,this._eventReverseLookup[t]=e)}},{key:"_unregisterEventCallbacks",value:function(e,t){e&&t&&this._eventReverseLookup[t]===e&&(delete this._eventCallbacks[e],delete this._eventReverseLookup[t])}},{key:"_handleEventCallbacks",value:function(e,t){e&&"function"==typeof this._eventCallbacks[e]&&this._eventCallbacks[e].call(this._eventCallbacks[e],t)}},{key:"_sendMessage",value:function(e,t,i){this._target&&("on"===e.name?this._registerEventCallbacks(e.actionId,t):"off"===e.name?this._unregisterEventCallbacks(e.actionId,t):this._registerResponseCallbacks(e.actionId,t,i),this._target.postMessage(this._createMessage(e),this._targetOrigin))}},{key:"_receiveMessage",value:function(t){if(t.origin===this._targetOrigin){var i=this._parseMessage(t.data);if(null!==i)if(i.status&&"success"!==i.status)this._rejectResponseCallbacks(i.actionId,i.payload);else switch(i.type){case"ready":this._resolveResponseCallbacks(this._apiKey);break;case"api":var n=0===i.actionId.indexOf(e.APISERVICE_INIT)?this:{};this._injectAPI(n,i.payload),this._resolveResponseCallbacks(i.actionId,n);break;case"event":this._handleEventCallbacks(i.actionId,i.payload);break;default:this._resolveResponseCallbacks(i.actionId,i.payload)}}}},{key:"_createMessage",value:function(t){return e.APIHEADER+e.APIHEADER_DELIMITER+this._apiKey+e.APIHEADER_DELIMITER+JSON.stringify(t)}},{key:"_parseMessage",value:function(e){var t=this._message_regex.exec(e);return"object"===(void 0===t?"undefined":_typeof(t))&&null!==t?(this._message_regex.lastIndex=0,JSON.parse(t[2])):null}},{key:"_injectAPI",value:function(e,t){var i=this;Object.keys(t).forEach(function(n){"apiId"===n?e[n]=t[n]:t[n].apiId?(e[n]={},i._injectAPI(e[n],t[n])):"enum"===t[n].type?e[n]=t[n].values:"method"===t[n].type&&(e[n]=i._getAPIMethod(n,t.apiId))})}},{key:"_getAPIMethod",value:function(t,i){var n=this;return"on"===t?function(){for(var s=arguments.length,a=Array(s),o=0;o<s;o++)a[o]=arguments[o];var r=Array.prototype.slice.call(a),l=r[1];n._sendMessage({apiId:i,actionId:e._createUID(t),name:t,parameters:r},l,l)}:"off"===t?function(){for(var e=arguments.length,s=Array(e),a=0;a<e;a++)s[a]=arguments[a];var o=Array.prototype.slice.call(s),r=o[1];n._sendMessage({apiId:i,actionId:n._eventReverseLookup[r],name:t,parameters:o},r,r)}:function(){for(var s=arguments.length,a=Array(s),o=0;o<s;o++)a[o]=arguments[o];var r=Array.prototype.slice.call(a);return new Promise(function(s,a){n._sendMessage({apiId:i,actionId:e._createUID(t),name:t,parameters:r},s,a)})}}}],[{key:"_updateModuleDefinitions",value:function(t,i){if(!t||!t.dataSources||!t.dataSources.sources)return Promise.resolve(t);var n=[];if(t.dataSources.sources.forEach(function(e){e.clientId&&n.push(e.clientId)}),0===n.length)return Promise.resolve(t);var s=i(n);return s&&"function"==typeof s.then?s.then(function(i){return e._doModuleUpdate(t,i)}):Promise.resolve(e._doModuleUpdate(t,s))}},{key:"_doModuleUpdate",value:function(e,t){var i=JSON.parse(JSON.stringify(e));if(t){var n=!0,s=!1,a=void 0;try{for(var o,r=i.dataSources.sources[Symbol.iterator]();!(n=(o=r.next()).done);n=!0){var l=o.value,c=!0,u=!1,_=void 0;try{for(var p,d=t[Symbol.iterator]();!(c=(p=d.next()).done);c=!0){var h=p.value;h.id===l.clientId&&(h.module&&(l.module=h.module),h.name&&(l.name=h.name))}}catch(e){u=!0,_=e}finally{try{!c&&d.return&&d.return()}finally{if(u)throw _}}}}catch(e){s=!0,a=e}finally{try{!n&&r.return&&r.return()}finally{if(s)throw a}}}return i}},{key:"_createUID",value:function(t){var i=Date.now().valueOf();return e.__uid=e.__uid===i?i+1:i,t+"_"+e.__uid.toString(16)}}]),e}();CognosApi.EVENTS={REQUEST_ERROR:"api:error:request"},CognosApi.APIHEADER_DELIMITER="#",CognosApi.APIHEADER_MARKER="capi",CognosApi.APIHEADER_VERSION="v1",CognosApi.APIHEADER=CognosApi.APIHEADER_DELIMITER+CognosApi.APIHEADER_MARKER+CognosApi.APIHEADER_DELIMITER+CognosApi.APIHEADER_VERSION,CognosApi.APISERVICE_INIT="getAppApi",CognosApi.APISERVICE_ON="on",CognosApi.APISERVICE_OFF="off",CognosApi.APISERVICE_DESTROY="destroyAppApi",CognosApi.APISERVICE_CLASS="capi-service";